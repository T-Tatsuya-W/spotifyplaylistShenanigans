<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Spotify Playlist Fetcher</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  button, select { padding: 10px; margin: 10px 0; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  th { background-color: #f4f4f4; }
</style>
</head>
<body>
<h2>Spotify Playlist Fetcher</h2>
<div>Status: <span id="status">Not logged in</span></div>
<button id="loginBtn">Login with Spotify</button>
<select id="playlistSelect" disabled></select>
<button id="loadBtn" disabled>Load Tracks</button>
<div id="output"></div>

<script>
const CLIENT_ID = "7e36be9f10ef4de09e938b5c787adf42";
const REDIRECT_URI = location.hostname === "localhost" ? "http://localhost:8000/" : "https://your-github-username.github.io/spotifyplaylistShenanigans/";

async function sha256(s) {
  const buffer = new TextEncoder().encode(s);
  const hash = await crypto.subtle.digest("SHA-256", buffer);
  return btoa(String.fromCharCode(...new Uint8Array(hash))).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
}

function randomString(length = 64) {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  return Array.from(crypto.getRandomValues(new Uint8Array(length))).map(x => chars[x % chars.length]).join("");
}

async function login() {
  const verifier = randomString();
  const challenge = await sha256(verifier);
  sessionStorage.setItem("verifier", verifier);
  const authUrl = new URL("https://accounts.spotify.com/authorize");
  authUrl.searchParams.set("response_type", "code");
  authUrl.searchParams.set("client_id", CLIENT_ID);
  authUrl.searchParams.set("redirect_uri", REDIRECT_URI);
  authUrl.searchParams.set("scope", "playlist-read-private");
  authUrl.searchParams.set("code_challenge_method", "S256");
  authUrl.searchParams.set("code_challenge", challenge);
  location.href = authUrl.toString();
}

async function fetchToken() {
  const params = new URLSearchParams(location.search);
  if (!params.has("code")) return;
  const code = params.get("code");
  const verifier = sessionStorage.getItem("verifier");
  const body = new URLSearchParams({
    grant_type: "authorization_code",
    code,
    redirect_uri: REDIRECT_URI,
    client_id: CLIENT_ID,
    code_verifier: verifier
  });
  const response = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body
  });
  const data = await response.json();
  if (data.access_token) {
    sessionStorage.setItem("access_token", data.access_token);
    document.getElementById("status").textContent = "Logged in";
    history.replaceState({}, document.title, location.pathname);
  }
}

async function fetchPlaylists() {
  const token = sessionStorage.getItem("access_token");
  const response = await fetch("https://api.spotify.com/v1/me/playlists", {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await response.json();
  const select = document.getElementById("playlistSelect");
  select.innerHTML = data.items.map(p => `<option value="${p.id}">${p.name}</option>`).join("");
  select.disabled = false;
  document.getElementById("loadBtn").disabled = false;
}

async function loadTracks() {
  const playlistId = document.getElementById("playlistSelect").value;
  const token = sessionStorage.getItem("access_token");
  const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const data = await response.json();
  const output = document.getElementById("output");
  output.innerHTML = `<table>
    <tr><th>#</th><th>Track</th><th>Artist</th></tr>
    ${data.items.map((item, index) => `
      <tr>
        <td>${index + 1}</td>
        <td>${item.track.name}</td>
        <td>${item.track.artists.map(a => a.name).join(", ")}</td>
      </tr>`).join("")}
  </table>`;
}

document.getElementById("loginBtn").onclick = login;
document.getElementById("loadBtn").onclick = loadTracks;

fetchToken().then(fetchPlaylists);
</script>
</body>
</html>
