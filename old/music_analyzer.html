<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ Spotify Music Analyzer & Playlist Creator</title>
    
    <!-- External Libraries -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 320px minmax(300px, 500px) 1fr;
            grid-template-rows: 1fr auto;
            gap: 20px;
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
            height: 100vh;
            box-sizing: border-box;
        }

        .filters-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            height: 100%;
        }

        .filters-panel h2 {
            color: #1DB954;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-align: center;
        }

        .filter-group {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(29, 185, 84, 0.05);
            border-radius: 10px;
            border-left: 4px solid #1DB954;
        }

        .filter-histogram {
            width: 100%;
            height: 60px;
            margin: 10px 0;
            border-radius: 5px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.8);
        }

        .filter-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .filter-value {
            background: #1DB954;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .range-slider {
            width: 100%;
            margin: 10px 0;
        }

        .range-input {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1DB954;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .range-input::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1DB954;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
            overflow: hidden;
        }

        .songs-list {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .songs-header {
            background: #1DB954;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .songs-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .songs-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .song-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .song-item:hover {
            background: rgba(29, 185, 84, 0.05);
            transform: translateX(5px);
        }

        .song-item:last-child {
            border-bottom: none;
        }

        .song-info {
            flex-grow: 1;
        }

        .song-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .song-artist {
            color: #666;
            font-size: 0.9em;
        }

        .song-stats {
            font-size: 0.8em;
            color: #999;
            display: flex;
            gap: 10px;
        }

        .visualization-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .viz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .viz-title {
            color: #1DB954;
            font-size: 1.3em;
            font-weight: 600;
        }

        .selected-count {
            background: #1DB954;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 500;
        }

        #scatter-plot {
            width: min(800px, calc(100vw - 700px));
            height: min(800px, calc(100vw - 700px));
            min-width: 400px;
            min-height: 400px;
            border-radius: 10px;
            border: 2px solid #f0f0f0;
        }

        .footer {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-summary {
            display: flex;
            gap: 30px;
            color: #666;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #1DB954;
            display: block;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        .playlist-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #1DB954;
            color: white;
            box-shadow: 0 4px 15px rgba(29, 185, 84, 0.3);
        }

        .btn-primary:hover {
            background: #1ed760;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(29, 185, 84, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1DB954;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .container {
                grid-template-columns: 280px minmax(280px, 400px) 1fr;
            }
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 250px minmax(250px, 350px) 1fr;
            }
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                height: 100vh;
            }
            
            .main-content {
                display: grid;
                grid-template-rows: 1fr 1fr 1fr;
                gap: 10px;
                height: 100%;
                overflow: hidden;
            }
            
            .filters-panel {
                height: 100%;
                overflow-y: auto;
            }
            
            .songs-list {
                height: 100%;
            }
            
            .visualization-panel {
                height: 100%;
            }
            
            #scatter-plot {
                width: 90vw;
                height: 60vw;
                max-width: 400px;
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Filters Panel -->
        <div class="filters-panel">
            <h2>üéõÔ∏è Audio Filters</h2>
            <div id="filters-container">
                <!-- Filters will be dynamically generated here -->
            </div>
            <button class="btn btn-secondary" onclick="resetFilters()" style="width: 100%; margin-top: 15px;">
                Reset All Filters
            </button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Songs List -->
            <div class="songs-list">
                <div class="songs-header">
                    <span>üéµ Filtered Songs</span>
                    <span class="songs-count" id="songs-count">0 songs</span>
                </div>
                <div class="songs-container" id="songs-container">
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        Loading your music database...
                    </div>
                </div>
            </div>
        </div>

        <!-- Visualization Panel -->
        <div class="visualization-panel">
            <div class="viz-header">
                <span class="viz-title">üìä Valence vs Energy</span>
                <span class="selected-count" id="selected-count">0 selected</span>
            </div>
            <div id="scatter-plot"></div>
            <div style="margin-top: 15px; text-align: center; color: #666; font-size: 0.9em;">
                üí° Click points to select ‚Ä¢ Box/lasso select regions ‚Ä¢ Click selected songs to deselect
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="stats-summary">
                <div class="stat-item">
                    <span class="stat-value" id="total-songs">0</span>
                    <span class="stat-label">Total Songs</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="filtered-songs">0</span>
                    <span class="stat-label">Filtered</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="selected-songs">0</span>
                    <span class="stat-label">Selected</span>
                </div>
            </div>
            
            <div class="playlist-controls">
                <button class="btn btn-secondary" onclick="clearSelection()">
                    üîò Deselect All
                </button>
                <button class="btn btn-secondary" id="spotify-login-btn" onclick="authenticateSpotify()" style="display: none;">
                    üîê Login to Spotify
                </button>
                <button class="btn btn-primary" id="create-playlist-btn" onclick="createPlaylist()" style="display: none;" disabled>
                    üéµ Create Playlist
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let musicData = [];
        let filteredData = [];
        let selectedSongs = new Set();
        let filters = {};

        // Audio features to create filters for
        const audioFeatures = [
            { key: 'BPM', label: 'BPM', min: 60, max: 200 },
            { key: 'Energy', label: 'Energy', min: 0, max: 100 },
            { key: 'Dance', label: 'Danceability', min: 0, max: 100 },
            { key: 'Loud', label: 'Loudness', min: -30, max: 0 },
            { key: 'Valence', label: 'Valence', min: 0, max: 100 },
            { key: 'Acoustic', label: 'Acoustic', min: 0, max: 100 },
            { key: 'Spotify_Popularity', label: 'Popularity', min: 0, max: 100 },
            { key: 'Release_Year', label: 'Release Year', min: 2000, max: 2025 }
        ];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            showLoading(true);
            
            // Load Spotify config first, then check auth
            console.log('üîÑ Loading Spotify config...');
            await loadSpotifyConfig();
            
            console.log('üîÑ Checking Spotify authentication...');
            await checkSpotifyAuth();
            
            // Load music data
            console.log('üîÑ Loading music data...');
            await loadMusicData();
        });

        function showLoading(show) {
            const loading = document.getElementById('loading');
            loading.style.display = show ? 'block' : 'none';
        }

        async function loadMusicData() {
            try {
                // Load CSV data first
                await loadCSVData();
                
                // Initialize everything after data is loaded
                initializeFilters();
                applyFilters();
                updateVisualization();
                updateStats();
                showLoading(false);
                
                console.log('‚úÖ Music analyzer fully loaded and ready');
                
            } catch (error) {
                console.error('‚ùå Error loading music data:', error);
                showError('Failed to load music database. Please ensure spotify_master_database.csv is accessible.');
            }
        }

        async function loadCSVData() {
            try {
                console.log('üîÑ Loading music database...');
                const response = await fetch('/api/music-data');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                musicData = await response.json();
                
                console.log(`‚úÖ Loaded ${musicData.length} songs from database`);
                document.getElementById('total-songs').textContent = musicData.length;
                
            } catch (error) {
                console.error('‚ùå CSV loading error:', error);
                console.log('üîÑ Using sample data for demonstration...');
                // Fallback: create sample data for demonstration
                createSampleData();
            }
        }

        // CSV parsing is now handled by the Python server

        function createSampleData() {
            console.log('üé≠ Creating sample music data for demonstration...');
            
            // Realistic sample songs with proper audio features
            const sampleSongs = [
                { title: "Shape of You", artist: "Ed Sheeran", bpm: 96, energy: 65, dance: 83, valence: 93, acoustic: 58, popularity: 85 },
                { title: "Blinding Lights", artist: "The Weeknd", bpm: 171, energy: 73, dance: 51, valence: 33, acoustic: 0, popularity: 88 },
                { title: "Watermelon Sugar", artist: "Harry Styles", bpm: 95, energy: 54, dance: 73, valence: 56, acoustic: 12, popularity: 84 },
                { title: "Levitating", artist: "Dua Lipa", bpm: 103, energy: 82, dance: 70, valence: 87, acoustic: 8, popularity: 86 },
                { title: "Good 4 U", artist: "Olivia Rodrigo", bpm: 166, energy: 66, dance: 63, valence: 56, acoustic: 11, popularity: 82 },
                { title: "Peaches", artist: "Justin Bieber", bpm: 90, energy: 45, dance: 68, valence: 58, acoustic: 23, popularity: 78 },
                { title: "Montero", artist: "Lil Nas X", bpm: 150, energy: 71, dance: 78, valence: 43, acoustic: 2, popularity: 79 },
                { title: "Stay", artist: "The Kid LAROI & Justin Bieber", bpm: 169, energy: 76, dance: 59, valence: 23, acoustic: 5, popularity: 92 },
                { title: "Anti-Hero", artist: "Taylor Swift", bpm: 97, energy: 54, dance: 68, valence: 42, acoustic: 35, popularity: 91 },
                { title: "As It Was", artist: "Harry Styles", bpm: 173, energy: 68, dance: 77, valence: 46, acoustic: 34, popularity: 90 }
            ];
            
            musicData = [];
            
            sampleSongs.forEach((song, index) => {
                musicData.push({
                    Title: song.title,
                    Artist: song.artist,
                    BPM: song.bpm,
                    Energy: song.energy,
                    Dance: song.dance,
                    Loud: Math.floor(Math.random() * 20) - 15, // -15 to -5 dB range
                    Valence: song.valence,
                    Acoustic: song.acoustic,
                    Spotify_Popularity: song.popularity,
                    Spotify_Track_ID: `sample_track_${index + 1}`
                });
            });
            
            // Generate additional realistic variations
            for (let i = 0; i < 40; i++) {
                const baseGenres = [
                    { name: "Pop", bpm: [95, 128], energy: [50, 80], dance: [60, 85], valence: [40, 80], acoustic: [5, 30] },
                    { name: "Rock", bpm: [110, 140], energy: [70, 95], dance: [40, 70], valence: [30, 70], acoustic: [0, 15] },
                    { name: "Hip-Hop", bpm: [70, 140], energy: [60, 90], dance: [70, 95], valence: [20, 60], acoustic: [0, 10] },
                    { name: "Electronic", bpm: [120, 180], energy: [75, 100], dance: [80, 100], valence: [50, 90], acoustic: [0, 5] },
                    { name: "Acoustic", bpm: [80, 120], energy: [20, 60], dance: [30, 60], valence: [30, 80], acoustic: [70, 100] },
                    { name: "Jazz", bpm: [60, 180], energy: [30, 70], dance: [40, 75], valence: [40, 85], acoustic: [20, 60] }
                ];
                
                const genre = baseGenres[Math.floor(Math.random() * baseGenres.length)];
                
                musicData.push({
                    Title: `${genre.name} Song ${i + 1}`,
                    Artist: `${genre.name} Artist ${i + 1}`,
                    BPM: Math.floor(Math.random() * (genre.bpm[1] - genre.bpm[0])) + genre.bpm[0],
                    Energy: Math.floor(Math.random() * (genre.energy[1] - genre.energy[0])) + genre.energy[0],
                    Dance: Math.floor(Math.random() * (genre.dance[1] - genre.dance[0])) + genre.dance[0],
                    Loud: Math.floor(Math.random() * 20) - 15,
                    Valence: Math.floor(Math.random() * (genre.valence[1] - genre.valence[0])) + genre.valence[0],
                    Acoustic: Math.floor(Math.random() * (genre.acoustic[1] - genre.acoustic[0])) + genre.acoustic[0],
                    Spotify_Popularity: Math.floor(Math.random() * 60) + 20, // 20-80 range
                    Spotify_Track_ID: `sample_${genre.name.toLowerCase()}_${i + 1}`
                });
            }
            
            console.log(`üìä Created ${musicData.length} sample songs across multiple genres`);
            document.getElementById('total-songs').textContent = musicData.length;
        }

        function initializeFilters() {
            const container = document.getElementById('filters-container');
            
            audioFeatures.forEach(feature => {
                // Calculate actual min/max from data
                const values = musicData.map(song => song[feature.key]).filter(val => !isNaN(val));
                const actualMin = Math.min(...values);
                const actualMax = Math.max(...values);
                
                // Initialize filter
                filters[feature.key] = {
                    min: actualMin,
                    max: actualMax,
                    currentMin: actualMin,
                    currentMax: actualMax
                };
                
                // Create filter UI
                const filterDiv = document.createElement('div');
                filterDiv.className = 'filter-group';
                filterDiv.innerHTML = `
                    <div class="filter-label">
                        <span>${feature.label}</span>
                        <span class="filter-value" id="${feature.key}-value">
                            ${Math.round(actualMin)} - ${Math.round(actualMax)}
                        </span>
                    </div>
                    <div class="filter-histogram" id="${feature.key}-histogram"></div>
                    <input type="range" 
                           class="range-input" 
                           id="${feature.key}-min" 
                           min="${actualMin}" 
                           max="${actualMax}" 
                           value="${actualMin}"
                           oninput="updateFilter('${feature.key}', 'min', this.value)">
                    <input type="range" 
                           class="range-input" 
                           id="${feature.key}-max" 
                           min="${actualMin}" 
                           max="${actualMax}" 
                           value="${actualMax}"
                           oninput="updateFilter('${feature.key}', 'max', this.value)">
                `;
                
                container.appendChild(filterDiv);
                
                // Create histogram for this feature
                createFilterHistogram(feature.key, values);
            });
        }

        function createFilterHistogram(featureKey, values) {
            const histogramDiv = document.getElementById(`${featureKey}-histogram`);
            
            // Create bins for histogram
            const numBins = 20;
            const min = Math.min(...values);
            const max = Math.max(...values);
            const binSize = (max - min) / numBins;
            const bins = new Array(numBins).fill(0);
            
            // Count values in each bin
            values.forEach(value => {
                const binIndex = Math.min(Math.floor((value - min) / binSize), numBins - 1);
                bins[binIndex]++;
            });
            
            const maxCount = Math.max(...bins);
            
            // Create simple bar chart using Plotly
            const trace = {
                x: bins.map((_, i) => min + (i + 0.5) * binSize),
                y: bins,
                type: 'bar',
                marker: {
                    color: bins.map((count, i) => {
                        const intensity = count / maxCount;
                        return `rgba(29, 185, 84, ${0.3 + intensity * 0.7})`;
                    }),
                    line: { width: 0 }
                },
                hovertemplate: '%{x:.1f}: %{y} songs<extra></extra>'
            };
            
            const layout = {
                margin: { l: 0, r: 0, t: 0, b: 0 },
                showlegend: false,
                xaxis: { 
                    showgrid: false, 
                    showticklabels: false, 
                    zeroline: false,
                    fixedrange: true
                },
                yaxis: { 
                    showgrid: false, 
                    showticklabels: false, 
                    zeroline: false,
                    fixedrange: true
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                bargap: 0.1
            };
            
            const config = {
                displayModeBar: false,
                responsive: true
            };
            
            Plotly.newPlot(histogramDiv, [trace], layout, config);
        }

        function updateFilterHistogram(featureKey, filterRange) {
            const histogramDiv = document.getElementById(`${featureKey}-histogram`);
            if (!histogramDiv || !histogramDiv.data) return;
            
            // Update bar colors to show filtered/unfiltered areas
            const trace = histogramDiv.data[0];
            const bins = trace.x;
            const counts = trace.y;
            const maxCount = Math.max(...counts);
            
            const updatedColors = bins.map((binCenter, i) => {
                const count = counts[i];
                const intensity = count / maxCount;
                
                // Check if this bin is within the filter range
                if (binCenter >= filterRange.currentMin && binCenter <= filterRange.currentMax) {
                    // Filtered area - bright green
                    return `rgba(29, 185, 84, ${0.6 + intensity * 0.4})`;
                } else {
                    // Filtered out area - gray
                    return `rgba(150, 150, 150, ${0.2 + intensity * 0.3})`;
                }
            });
            
            Plotly.restyle(histogramDiv, {'marker.color': [updatedColors]});
        }

        function updateFilter(feature, type, value) {
            const numValue = parseFloat(value);
            filters[feature][type === 'min' ? 'currentMin' : 'currentMax'] = numValue;
            
            // Ensure min <= max
            if (type === 'min' && numValue > filters[feature].currentMax) {
                filters[feature].currentMax = numValue;
                document.getElementById(`${feature}-max`).value = numValue;
            } else if (type === 'max' && numValue < filters[feature].currentMin) {
                filters[feature].currentMin = numValue;
                document.getElementById(`${feature}-min`).value = numValue;
            }
            
            // Update display
            const displayMin = Math.round(filters[feature].currentMin);
            const displayMax = Math.round(filters[feature].currentMax);
            document.getElementById(`${feature}-value`).textContent = `${displayMin} - ${displayMax}`;
            
            // Apply filters
            applyFilters();
            
            // Update histogram to show filtered range
            updateFilterHistogram(feature, filters[feature]);
        }

        function applyFilters() {
            filteredData = musicData.filter(song => {
                return audioFeatures.every(feature => {
                    const value = song[feature.key];
                    const filter = filters[feature.key];
                    return value >= filter.currentMin && value <= filter.currentMax;
                });
            });
            
            updateSongsList();
            updateVisualization();
            updateStats();
        }

        function updateSongsList() {
            const container = document.getElementById('songs-container');
            const songsCount = document.getElementById('songs-count');
            
            songsCount.textContent = `${filteredData.length} songs`;
            
            container.innerHTML = '';
            
            filteredData.forEach(song => {
                const songDiv = document.createElement('div');
                songDiv.className = 'song-item';
                songDiv.onclick = () => toggleSongSelection(song);
                
                songDiv.innerHTML = `
                    <div class="song-info">
                        <div class="song-title">${song.Title || 'Unknown Title'}</div>
                        <div class="song-artist">${song.Artist || 'Unknown Artist'}</div>
                        <div class="song-stats">
                            <span>‚ô´ ${song.BPM}bpm</span>
                            <span>‚ö° ${song.Energy}</span>
                            <span>üíÉ ${song.Dance}</span>
                            <span>üòä ${song.Valence}</span>
                        </div>
                    </div>
                `;
                
                if (selectedSongs.has(song.Spotify_Track_ID)) {
                    songDiv.style.background = 'rgba(29, 185, 84, 0.15)';
                    songDiv.style.borderLeft = '4px solid #1DB954';
                    songDiv.title = 'Click to deselect this song';
                } else {
                    songDiv.title = 'Click to select this song';
                }
                
                container.appendChild(songDiv);
            });
        }

        function updateVisualization() {
            const plotData = [{
                x: filteredData.map(song => song.Valence),
                y: filteredData.map(song => song.Energy),
                mode: 'markers',
                type: 'scatter',
                text: filteredData.map(song => `${song.Title}<br>by ${song.Artist}`),
                hovertemplate: '<b>%{text}</b><br>Valence: %{x}<br>Energy: %{y}<extra></extra>',
                marker: {
                    size: 8,
                    color: filteredData.map(song => 
                        selectedSongs.has(song.Spotify_Track_ID) ? '#1DB954' : '#666'
                    ),
                    opacity: 0.7,
                    line: {
                        width: 2,
                        color: filteredData.map(song => 
                            selectedSongs.has(song.Spotify_Track_ID) ? '#1DB954' : 'white'
                        )
                    }
                },
                customdata: filteredData.map(song => song.Spotify_Track_ID)
            }];

            const layout = {
                title: false,
                xaxis: {
                    title: 'Valence (Positivity) ‚Üí',
                    range: [0, 100],
                    gridcolor: '#f0f0f0',
                    showgrid: true,
                    fixedrange: false
                },
                yaxis: {
                    title: 'Energy ‚Üí',
                    range: [0, 100],
                    gridcolor: '#f0f0f0',
                    showgrid: true,
                    fixedrange: false
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                margin: { t: 20, r: 20, b: 50, l: 50 },
                font: { family: 'Segoe UI, sans-serif', size: 12 },
                hovermode: 'closest',
                dragmode: 'select',
                selectdirection: 'diagonal'
            };

            const config = {
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['zoom2d', 'pan2d', 'zoomIn2d', 'zoomOut2d', 'autoScale2d', 'resetScale2d'],
                modeBarButtonsToAdd: ['select2d', 'lasso2d'],
                responsive: false
            };

            Plotly.newPlot('scatter-plot', plotData, layout, config);

            // Add click handler for point selection
            document.getElementById('scatter-plot').on('plotly_click', function(data) {
                const pointIndex = data.points[0].pointIndex;
                toggleSongSelection(filteredData[pointIndex]);
            });

            // Add selection handler for box/lasso selection
            document.getElementById('scatter-plot').on('plotly_selected', function(data) {
                if (data && data.points && data.points.length > 0) {
                    console.log(`üì¶ Box selected ${data.points.length} songs`);
                    
                    // Add all selected points to selection
                    data.points.forEach(point => {
                        const song = filteredData[point.pointIndex];
                        selectedSongs.add(song.Spotify_Track_ID);
                    });
                    
                    updateSongsList();
                    updateVisualization();
                    updateStats();
                    
                    // Update create playlist button (only if it's visible and we have auth)
                    const createBtn = document.getElementById('create-playlist-btn');
                    if (createBtn.style.display !== 'none') {
                        createBtn.disabled = selectedSongs.size === 0;
                    }
                }
            });

            // Add deselect handler
            document.getElementById('scatter-plot').on('plotly_deselect', function() {
                // Don't clear selection on deselect - user might want to keep their selection
                console.log('üì¶ Box selection cleared, keeping current selection');
            });
        }

        function toggleSongSelection(song) {
            const trackId = song.Spotify_Track_ID;
            
            if (selectedSongs.has(trackId)) {
                selectedSongs.delete(trackId);
                console.log(`üîò Deselected: ${song.Title}`);
            } else {
                selectedSongs.add(trackId);
                console.log(`‚úÖ Selected: ${song.Title}`);
            }
            
            updateSongsList();
            updateVisualization();
            updateStats();
            
            // Update create playlist button (only if it's visible and we have auth)
            const createBtn = document.getElementById('create-playlist-btn');
            if (createBtn.style.display !== 'none') {
                createBtn.disabled = selectedSongs.size === 0;
            }
        }

        function updateStats() {
            document.getElementById('filtered-songs').textContent = filteredData.length;
            document.getElementById('selected-songs').textContent = selectedSongs.size;
            document.getElementById('selected-count').textContent = `${selectedSongs.size} selected`;
        }

        function resetFilters() {
            audioFeatures.forEach(feature => {
                filters[feature.key].currentMin = filters[feature.key].min;
                filters[feature.key].currentMax = filters[feature.key].max;
                
                document.getElementById(`${feature.key}-min`).value = filters[feature.key].min;
                document.getElementById(`${feature.key}-max`).value = filters[feature.key].max;
                
                const displayMin = Math.round(filters[feature.key].min);
                const displayMax = Math.round(filters[feature.key].max);
                document.getElementById(`${feature.key}-value`).textContent = `${displayMin} - ${displayMax}`;
            });
            
            applyFilters();
        }

        function clearSelection() {
            selectedSongs.clear();
            updateSongsList();
            updateVisualization();
            updateStats();
            
            document.getElementById('create-playlist-btn').disabled = true;
        }

        async function createPlaylist() {
            if (selectedSongs.size === 0) {
                alert('Please select some songs first!');
                return;
            }

            const createBtn = document.getElementById('create-playlist-btn');
            const originalText = createBtn.textContent;
            
            try {
                createBtn.textContent = 'üîÑ Creating...';
                createBtn.disabled = true;

                const selectedSongsList = filteredData.filter(song => 
                    selectedSongs.has(song.Spotify_Track_ID)
                );
                
                // Check if user is authenticated with Spotify
                const isAuthenticated = await checkSpotifyAuth();
                
                if (!isAuthenticated) {
                    const shouldLogin = confirm(
                        'üéµ Spotify Login Required\n\n' +
                        'To create playlists directly in your Spotify account, you need to log in.\n\n' +
                        'Click OK to log in, or Cancel to download as JSON file instead.'
                    );
                    
                    if (shouldLogin) {
                        await authenticateSpotify();
                        return; // Will retry after auth
                    } else {
                        // Fallback to JSON download
                        downloadPlaylistJSON(selectedSongsList);
                        return;
                    }
                }
                
                // Create playlist via Spotify API
                await createSpotifyPlaylist(selectedSongsList);
                
            } catch (error) {
                console.error('‚ùå Error creating playlist:', error);
                alert('‚ùå Failed to create playlist. Check console for details.');
                
                // Fallback to JSON download
                const selectedSongsList = filteredData.filter(song => 
                    selectedSongs.has(song.Spotify_Track_ID)
                );
                downloadPlaylistJSON(selectedSongsList);
                
            } finally {
                createBtn.textContent = originalText;
                createBtn.disabled = selectedSongs.size === 0;
            }
        }

        // Spotify API Configuration
        const SPOTIFY_CONFIG = {
            CLIENT_ID: '', // Will be loaded from server
            REDIRECT_URI: '', // Will be loaded from server to match exactly
            SCOPES: 'playlist-modify-public playlist-modify-private user-read-private'
        };

        let spotifyAccessToken = null;
        let spotifyUser = null;

        async function loadSpotifyConfig() {
            try {
                const response = await fetch('/api/spotify-config');
                const config = await response.json();
                SPOTIFY_CONFIG.CLIENT_ID = config.client_id;
                
                // Set redirect URI - use server provided one or fall back to current origin
                SPOTIFY_CONFIG.REDIRECT_URI = config.redirect_uri || `${window.location.origin}/spotify-callback`;
                
                console.log('‚úÖ Spotify configuration loaded');
                console.log(`üîó Client ID: ${SPOTIFY_CONFIG.CLIENT_ID}`);
                console.log(`üîó Redirect URI: ${SPOTIFY_CONFIG.REDIRECT_URI}`);
                
            } catch (error) {
                console.error('‚ùå Failed to load Spotify config:', error);
                // Fallback redirect URI
                SPOTIFY_CONFIG.REDIRECT_URI = `${window.location.origin}/spotify-callback`;
                console.log(`üîó Fallback Redirect URI: ${SPOTIFY_CONFIG.REDIRECT_URI}`);
            }
        }

        async function loadSpotifyUser() {
            if (!spotifyAccessToken) return false;
            
            try {
                const response = await fetch('https://api.spotify.com/v1/me', {
                    headers: {
                        'Authorization': `Bearer ${spotifyAccessToken}`
                    }
                });
                
                if (response.ok) {
                    spotifyUser = await response.json();
                    console.log(`‚úÖ Authenticated as ${spotifyUser.display_name}`);
                    updateAuthUI(true);
                    return true;
                } else {
                    // Token is invalid
                    spotifyAccessToken = null;
                    sessionStorage.removeItem("spotify_access_token");
                    updateAuthUI(false);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Failed to verify token:', error);
                updateAuthUI(false);
                return false;
            }
        }

        async function checkSpotifyAuth() {
            // First, try to complete OAuth flow if we have a code
            if (await completeSpotifyLogin()) {
                return true;
            }
            
            // Check for stored access token
            const storedToken = sessionStorage.getItem("spotify_access_token");
            if (storedToken) {
                spotifyAccessToken = storedToken;
                return await loadSpotifyUser();
            }
            
            // No authentication found
            updateAuthUI(false);
            return false;
        }

        function updateAuthUI(isAuthenticated) {
            const loginBtn = document.getElementById('spotify-login-btn');
            const createBtn = document.getElementById('create-playlist-btn');
            
            console.log(`üîÑ Updating auth UI: authenticated=${isAuthenticated}, user=${spotifyUser?.display_name}, clientId=${!!SPOTIFY_CONFIG.CLIENT_ID}`);
            
            if (isAuthenticated && spotifyUser) {
                // Authenticated: Hide login, show create playlist
                console.log('‚úÖ User authenticated, showing create playlist button');
                loginBtn.style.display = 'none';
                createBtn.style.display = 'inline-block';
                createBtn.disabled = selectedSongs.size === 0; // Only enable if songs selected
                createBtn.innerHTML = `üéµ Create Playlist (${spotifyUser.display_name})`;
            } else if (SPOTIFY_CONFIG.CLIENT_ID) {
                // Has config but not authenticated: Show login, hide create playlist
                console.log('üîê Showing login button');
                loginBtn.style.display = 'inline-block';
                createBtn.style.display = 'none';
                createBtn.disabled = true;
            } else {
                // No config: Hide login, show download option
                console.log('üìÅ No config, showing download option');
                loginBtn.style.display = 'none';
                createBtn.style.display = 'inline-block';
                createBtn.disabled = selectedSongs.size === 0;
                createBtn.innerHTML = 'üìÅ Download Playlist';
            }
        }

        /* ---------- PKCE OAuth Functions ---------- */
        async function sha256(s) {
            const buffer = new TextEncoder().encode(s);
            const digest = await crypto.subtle.digest('SHA-256', buffer);
            return btoa(String.fromCharCode(...new Uint8Array(digest)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        function randomString(length = 64) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            return Array.from(crypto.getRandomValues(new Uint8Array(length)))
                .map(x => chars[x % chars.length])
                .join('');
        }

        async function authenticateSpotify() {
            if (!SPOTIFY_CONFIG.CLIENT_ID) {
                await loadSpotifyConfig();
            }
            
            if (!SPOTIFY_CONFIG.CLIENT_ID) {
                alert('‚ùå Spotify configuration not available. Contact administrator.');
                return;
            }
            
            // Generate PKCE verifier and challenge
            const verifier = randomString();
            const challenge = await sha256(verifier);
            
            // Store verifier for later use
            sessionStorage.setItem('spotify_verifier', verifier);
            
            // Use exact redirect URI pattern from working example
            const redirectUri = (location.hostname === "127.0.0.1" || location.hostname === "localhost")
                ? "http://127.0.0.1:8000/"
                : `${location.protocol}//${location.host}/`;
            
            console.log(`üîó Using Client ID: ${SPOTIFY_CONFIG.CLIENT_ID}`);
            console.log(`üîó Using Redirect URI: ${redirectUri}`);
            
            const authUrl = new URL("https://accounts.spotify.com/authorize");
            authUrl.searchParams.set("response_type", "code");
            authUrl.searchParams.set("client_id", SPOTIFY_CONFIG.CLIENT_ID);
            authUrl.searchParams.set("scope", SPOTIFY_CONFIG.SCOPES);
            authUrl.searchParams.set("redirect_uri", redirectUri);
            authUrl.searchParams.set("code_challenge_method", "S256");
            authUrl.searchParams.set("code_challenge", challenge);
            authUrl.searchParams.set("show_dialog", "true");
            
            console.log(`üîê Full auth URL: ${authUrl.toString()}`);
            console.log('üîê Redirecting to Spotify authentication...');
            window.location.href = authUrl.toString();
        }

        async function completeSpotifyLogin() {
            const urlParams = new URLSearchParams(location.search);
            const code = urlParams.get("code");
            
            if (!code) {
                console.log('üîç No authorization code found in URL');
                return false;
            }
            
            console.log('üîê Found authorization code, completing OAuth flow...');
            const verifier = sessionStorage.getItem("spotify_verifier");
            
            if (!verifier) {
                console.error('‚ùå No verifier found in session storage');
                return false;
            }
            
            const redirectUri = (location.hostname === "127.0.0.1" || location.hostname === "localhost")
                ? "http://127.0.0.1:8000/"
                : `${location.protocol}//${location.host}/`;
            
            if (!SPOTIFY_CONFIG.CLIENT_ID) {
                console.error('‚ùå Spotify client ID not available');
                return false;
            }

            const tokenBody = new URLSearchParams({
                grant_type: "authorization_code",
                code: code,
                redirect_uri: redirectUri,
                client_id: SPOTIFY_CONFIG.CLIENT_ID,
                code_verifier: verifier
            });
            
            try {
                const response = await fetch("https://accounts.spotify.com/api/token", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: tokenBody
                });
                
                const data = await response.json();
                
                if (data.access_token) {
                    spotifyAccessToken = data.access_token;
                    sessionStorage.setItem("spotify_access_token", data.access_token);
                    sessionStorage.setItem("spotify_scopes", data.scope || "");
                    console.log('‚úÖ Spotify authentication successful');
                    
                    // Clean up URL
                    history.replaceState({}, document.title, location.pathname);
                    
                    // Fetch user info
                    await loadSpotifyUser();
                    return true;
                } else {
                    console.error("‚ùå Login failed:", data);
                    return false;
                }
            } catch (error) {
                console.error("‚ùå Token exchange failed:", error);
                return false;
            }
        }

        async function createSpotifyPlaylist(songs) {
            if (!spotifyAccessToken || !spotifyUser) {
                throw new Error('Not authenticated with Spotify');
            }

            const playlistName = `Music Analyzer Playlist ${new Date().toLocaleDateString()}`;
            const playlistDescription = `Created with Music Analyzer - ${songs.length} songs selected by audio features`;

            console.log(`üéµ Creating Spotify playlist: ${playlistName}`);

            // Create playlist
            const createResponse = await fetch(`https://api.spotify.com/v1/users/${spotifyUser.id}/playlists`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${spotifyAccessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: playlistName,
                    description: playlistDescription,
                    public: false
                })
            });

            if (!createResponse.ok) {
                const error = await createResponse.json();
                throw new Error(`Failed to create playlist: ${error.error?.message || 'Unknown error'}`);
            }

            const playlist = await createResponse.json();
            console.log(`‚úÖ Created playlist: ${playlist.name} (${playlist.id})`);

            // Add tracks to playlist
            const trackUris = songs.map(song => `spotify:track:${song.Spotify_Track_ID}`);
            
            // Spotify API allows max 100 tracks per request
            const batchSize = 100;
            for (let i = 0; i < trackUris.length; i += batchSize) {
                const batch = trackUris.slice(i, i + batchSize);
                
                const addResponse = await fetch(`https://api.spotify.com/v1/playlists/${playlist.id}/tracks`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${spotifyAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uris: batch
                    })
                });

                if (!addResponse.ok) {
                    const error = await addResponse.json();
                    console.error('‚ùå Failed to add tracks:', error);
                    // Continue with remaining batches
                }
            }

            // Success!
            const successMessage = 
                `üéâ Playlist Created Successfully!\n\n` +
                `üìù Name: ${playlist.name}\n` +
                `üéµ Songs: ${songs.length}\n` +
                `üë§ Account: ${spotifyUser.display_name}\n\n` +
                `Your playlist has been added to your Spotify library!`;
            
            alert(successMessage);
            
            // Clear selection after successful creation
            clearSelection();
        }

        function downloadPlaylistJSON(songs) {
            // Fallback: Download as JSON file
            const playlistData = {
                name: `Music Analyzer Playlist ${new Date().toLocaleDateString()}`,
                description: `Created with Music Analyzer - ${songs.length} songs`,
                tracks: songs.map(song => ({
                    title: song.Title,
                    artist: song.Artist,
                    spotify_uri: `spotify:track:${song.Spotify_Track_ID}`,
                    track_id: song.Spotify_Track_ID
                }))
            };
            
            const dataStr = JSON.stringify(playlistData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `spotify_playlist_${Date.now()}.json`;
            link.click();
            
            alert(`üìÅ Playlist downloaded as JSON file with ${songs.length} songs!`);
        }

        function showError(message) {
            const container = document.getElementById('songs-container');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #e74c3c;">
                    <h3>‚ùå Error</h3>
                    <p>${message}</p>
                </div>
            `;
            showLoading(false);
        }
    </script>
</body>
</html>