<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Spotify PKCE Demo – Create Playlist</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 32px; }
    button { padding: 10px 14px; margin: 8px 0; font-size: 16px; cursor: pointer; }
    #log { white-space: pre-wrap; border: 1px solid #ddd; padding: 12px; margin-top: 16px; font-size: 14px; }
    .ok { color: #087443; } .err { color: #a40000; }
  </style>
</head>
<body>
  <h1>Spotify PKCE Demo</h1>
  <p>This page logs in with PKCE and creates a playlist with one hard-coded track.</p>

  <button id="loginBtn">1) Log in with Spotify</button><br/>
  <button id="createBtn" disabled>2) Create demo playlist</button>

  <div id="log" aria-live="polite"></div>

<script>

/** ===== CONFIG (edit these) ===== */
const CLIENT_ID = "2a1b848324a04242b06d3a1d0e5c16d9";            // from developer dashboard
const TRACK_ID  = "7BRD7x5pt8Lqa1eGYC4dzj";        // e.g. "11dFghVXANMlKmJXsNCbNl"
const SCOPES = [
  "playlist-modify-public",
  "playlist-modify-private",
  "user-read-private" // needed to GET /me for your user id
].join(" ");

// Always use the exact URL that is allowlisted as your Redirect URI (HTTPS required).
// This uses the current page's full URL so it matches your deployed page.
const REDIRECT_URI = window.location.origin + window.location.pathname;

/** ===== Utilities ===== */
const logEl = document.getElementById("log");
function log(msg, cls="") {
  const p = document.createElement("div");
  if (cls) p.className = cls;
  p.textContent = msg;
  logEl.appendChild(p);
}

function generateRandomString(length) {
  const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  const values = crypto.getRandomValues(new Uint8Array(length));
  return values.reduce((acc, x) => acc + possible[x % possible.length], "");
}

async function sha256(plain) {
  const encoder = new TextEncoder();
  const data = encoder.encode(plain);
  return crypto.subtle.digest('SHA-256', data);
}

function base64urlencode(bytes) {
  const str = String.fromCharCode(...new Uint8Array(bytes));
  return btoa(str).replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
}

/** ===== PKCE Step 1: redirect to authorize ===== */
async function beginLogin() {
  const codeVerifier = generateRandomString(64);
  localStorage.setItem("code_verifier", codeVerifier);

  const codeChallenge = base64urlencode(await sha256(codeVerifier));

  const authUrl = new URL("https://accounts.spotify.com/authorize");
  authUrl.search = new URLSearchParams({
    response_type: "code",
    client_id: CLIENT_ID,
    scope: SCOPES,
    code_challenge_method: "S256",
    code_challenge: codeChallenge,
    redirect_uri: REDIRECT_URI,
    // optional: state to guard CSRF
    state: generateRandomString(16)
  }).toString();

  window.location.href = authUrl.toString();
}

/** ===== PKCE Step 2: exchange code for tokens ===== */
async function exchangeCodeForToken(code) {
  const codeVerifier = localStorage.getItem("code_verifier");
  if (!codeVerifier) throw new Error("Missing code_verifier from localStorage.");

  const body = new URLSearchParams({
    client_id: CLIENT_ID,
    grant_type: "authorization_code",
    code,
    redirect_uri: REDIRECT_URI,
    code_verifier: codeVerifier
  });

  const resp = await fetch("https://accounts.spotify.com/api/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body
  });

  const data = await resp.json();
  if (!resp.ok) throw new Error((data && data.error_description) || resp.statusText);

  localStorage.setItem("access_token", data.access_token);
  localStorage.setItem("refresh_token", data.refresh_token || "");
  return data.access_token;
}

/** Helper to call Web API with bearer token */
async function apiFetch(path, options = {}) {
  const token = localStorage.getItem("access_token");
  if (!token) throw new Error("No access token.");
  const resp = await fetch(`https://api.spotify.com/v1${path}`, {
    ...options,
    headers: {
      "Authorization": `Bearer ${token}`,
      "Content-Type": "application/json",
      ...(options.headers || {})
    }
  });
  if (resp.status === 401) {
    throw new Error("Unauthorized (token expired?)");
  }
  const text = await resp.text();
  try { return { ok: resp.ok, status: resp.status, json: JSON.parse(text) }; }
  catch { return { ok: resp.ok, status: resp.status, json: text }; }
}

/** ===== Demo: create a playlist and add one track ===== */
async function createDemoPlaylist() {
  try {
    log("Fetching your profile (/me)…");
    const me = await apiFetch("/me");
    if (!me.ok) throw new Error(JSON.stringify(me.json));
    const userId = me.json.id;
    log(`Hello ${me.json.display_name || userId}!`, "ok");

    log("Creating playlist…");
    const newPl = await apiFetch(`/users/${encodeURIComponent(userId)}/playlists`, {
      method: "POST",
      body: JSON.stringify({
        name: "PKCE Demo Playlist",
        description: "Created by a static HTML PKCE demo",
        public: false
      })
    });
    if (!newPl.ok) throw new Error(JSON.stringify(newPl.json));
    const playlistId = newPl.json.id;
    log(`Created: ${newPl.json.name}`, "ok");

    log("Adding track to playlist…");
    const uri = `spotify:track:${TRACK_ID}`;
    const add = await apiFetch(`/playlists/${encodeURIComponent(playlistId)}/tracks`, {
      method: "POST",
      body: JSON.stringify({ uris: [uri] })
    });
    if (!add.ok) throw new Error(JSON.stringify(add.json));

    const url = newPl.json.external_urls?.spotify || `https://open.spotify.com/playlist/${playlistId}`;
    log(`Done! Open playlist: ${url}`, "ok");
  } catch (e) {
    log(`Error: ${e.message}`, "err");
    console.error(e);
  }
}

/** ===== On load: if redirected back with ?code=… exchange it ===== */
(async function init() {
  document.getElementById("loginBtn").addEventListener("click", beginLogin);
  document.getElementById("createBtn").addEventListener("click", createDemoPlaylist);

  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");
  const error = params.get("error");

  if (error) {
    log(`Auth error: ${error}`, "err");
    return;
  }
  if (code) {
    try {
      log("Exchanging authorization code for access token…");
      await exchangeCodeForToken(code);
      // clean URL (remove ?code=…)
      window.history.replaceState({}, document.title, window.location.pathname);
      log("Logged in. You can now create a playlist.", "ok");
      document.getElementById("createBtn").disabled = false;
    } catch (e) {
      log(`Token exchange failed: ${e.message}`, "err");
    }
  } else {
    // If we already have a token from a prior login, enable the button.
    if (localStorage.getItem("access_token")) {
      document.getElementById("createBtn").disabled = false;
      log("Token present. Ready to create a playlist.", "ok");
    } else {
      log("Click ‘Log in with Spotify’ to start.", "ok");
    }
  }
})();
</script>
</body>
</html>
