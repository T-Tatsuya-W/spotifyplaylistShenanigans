<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Spotify Playlist – Simple Loader</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
  button, select { padding: 8px 12px; margin: 6px 0; }
  table { border-collapse: collapse; margin-top: 16px; width: 100%; font-size: 14px; }
  th, td { border: 1px solid #ddd; padding: 6px; text-align: left; vertical-align: middle; }
  th { background: #f2f2f2; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  .muted { color:#666; font-size:12px; }
</style>
</head>
<body>
<h2>Spotify Playlist – Simple Loader</h2>
<div>Status: <span id="status">Not logged in</span></div>
<div class="row">
  <button id="loginBtn">Login with Spotify</button>
  <button id="logoutBtn">Logout</button>
</div>
<hr/>
<div class="row">
  <label>Choose one of your playlists:</label>
  <select id="playlistSelect" disabled></select>
  <button id="loadBtn" disabled>Load Tracks</button>
</div>

<div id="output"></div>

<script>
/* ---------- CONFIG ---------- */
const CLIENT_ID = "7e36be9f10ef4de09e938b5c787adf42";
const REDIRECT_URI = (location.hostname === "127.0.0.1" || location.hostname === "localhost")
  ? "http://127.0.0.1:8000/"
  : "https://t-tatsuya-w.github.io/spotifyplaylistShenanigans/";

/* ---------- PKCE OAuth ---------- */
async function sha256(s){const b=new TextEncoder().encode(s);const d=await crypto.subtle.digest('SHA-256',b);return btoa(String.fromCharCode(...new Uint8Array(d))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'')}
function randomString(n=64){const c='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';return Array.from(crypto.getRandomValues(new Uint8Array(n))).map(x=>c[x%c.length]).join('')}
async function beginLogin(){
  const verifier=randomString(), challenge=await sha256(verifier);
  sessionStorage.setItem('verifier',verifier);
  const scopes="playlist-read-private playlist-read-collaborative";
  const u=new URL("https://accounts.spotify.com/authorize");
  u.searchParams.set("response_type","code");
  u.searchParams.set("client_id",CLIENT_ID);
  u.searchParams.set("scope",scopes);
  u.searchParams.set("redirect_uri",REDIRECT_URI);
  u.searchParams.set("code_challenge_method","S256");
  u.searchParams.set("code_challenge",challenge);
  location = u.toString();
}
async function completeLogin(){
  const p=new URLSearchParams(location.search);
  if(!p.get("code")) return;
  const code=p.get("code"), verifier=sessionStorage.getItem("verifier");
  const body=new URLSearchParams({grant_type:"authorization_code", code, redirect_uri:REDIRECT_URI, client_id:CLIENT_ID, code_verifier:verifier});
  const res=await fetch("https://accounts.spotify.com/api/token",{method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body});
  const data=await res.json();
  if(data.access_token){
    sessionStorage.setItem("access_token",data.access_token);
    sessionStorage.setItem("scopes",data.scope||"");
    document.getElementById("status").textContent = "Logged in (scopes: "+(data.scope||"")+")";
    history.replaceState({},document.title,location.pathname);
  } else {
    document.getElementById("status").textContent="Login failed";
    console.error("Login failed:", data);
  }
}
function token(){return sessionStorage.getItem("access_token");}

/* ---------- Spotify helpers ---------- */
async function spFetch(pathOrUrl){
  const t = token();
  const url = pathOrUrl.startsWith("http") ? pathOrUrl : "https://api.spotify.com/v1"+pathOrUrl;
  const res = await fetch(url, { headers:{ "Authorization":`Bearer ${t}`, "Accept":"application/json" } });
  if(!res.ok){
    const text = await res.text();
    console.error("Spotify API error:", res.status, text);
    throw new Error(`HTTP ${res.status} - ${text}`);
  }
  return res.json();
}
async function fetchUserPlaylists(){
  let url="https://api.spotify.com/v1/me/playlists?limit=50"; const all=[];
  while(url){ const page=await spFetch(url); all.push(...(page.items||[])); url=page.next; }
  return all;
}
async function fetchPlaylistTracks(playlistId){
  let url=`https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=100&market=from_token`;
  const items=[];
  while(url){ const page=await spFetch(url); items.push(...(page.items||[])); url=page.next; }
  return items.map(it=>it.track).filter(t=>t && t.id);
}

/* ---------- UI helpers ---------- */
function escapeHtml(s){return s.replace(/[&<>'"]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","'":"&#39;",'"':"&quot;"}[c]))}

/* ---------- App ---------- */
(async function init(){
  await completeLogin();
  const status = document.getElementById("status");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const playlistSelect = document.getElementById("playlistSelect");
  const loadBtn = document.getElementById("loadBtn");
  const output = document.getElementById("output");

  loginBtn.onclick = beginLogin;
  logoutBtn.onclick = () => {
    sessionStorage.clear();
    status.textContent="Logged out";
    playlistSelect.innerHTML="";
    playlistSelect.disabled=true;
    loadBtn.disabled=true;
    output.innerHTML="";
  };

  if(token()){
    status.textContent = "Logged in (scopes: "+(sessionStorage.getItem("scopes")||"")+")";
    try{
      const pls = await fetchUserPlaylists();
      playlistSelect.innerHTML = pls.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join("");
      playlistSelect.disabled = false;
      loadBtn.disabled = false;
    }catch(e){
      status.textContent = "Error fetching playlists: "+e.message;
    }
  }

  loadBtn.onclick = async () => {
    const pid = playlistSelect.value; if(!pid) return;
    status.textContent = "Loading tracks…";
    try{
      const tracks = await fetchPlaylistTracks(pid);

      let html = `<table><tr>
        <th>#</th><th>Track</th><th>Artist(s)</th><th>Action</th>
      </tr>`;
      tracks.forEach((t,i)=>{
        const artists = t.artists.map(a=>a.name).join(", ");
        html += `<tr>
          <td>${i+1}</td>
          <td>${escapeHtml(t.name)}</td>
          <td>${escapeHtml(artists)}</td>
          <td><button class="actionBtn" data-id="${t.id}" data-name="${escapeHtml(t.name)}" data-artists="${escapeHtml(artists)}">Do Action</button></td>
        </tr>`;
      });
      html += `</table>`;
      output.innerHTML = html;
      status.textContent = `Loaded ${tracks.length} tracks.`;

      // Wire the placeholder action buttons
      document.querySelectorAll(".actionBtn").forEach(btn=>{
        btn.onclick = (ev)=>{
          const name = ev.currentTarget.getAttribute("data-name");
          const artists = ev.currentTarget.getAttribute("data-artists");
          status.textContent = `Ready: ${name} — ${artists}`;
          // later: replace this with your API call, keep the same data attributes
        };
      });

    }catch(e){
      status.textContent = "Error loading tracks: "+e.message;
    }
  };
})();
</script>
</body>
</html>
